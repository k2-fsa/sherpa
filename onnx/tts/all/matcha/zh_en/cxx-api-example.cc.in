#include <cstdint>
#include <cstdio>
#include <string>

#include "sherpa-onnx/c-api/cxx-api.h"

static int32_t ProgressCallback(const float *samples, int32_t num_samples,
                                float progress, void *arg) {
  fprintf(stderr, "Progress: %.3f%%\n", progress * 100);
  // return 1 to continue generating
  // return 0 to stop generating
  return 1;
}

int32_t main(int32_t argc, char *argv[]) {
  using namespace sherpa_onnx::cxx; // NOLINT
  OfflineTtsConfig config;
  config.model.matcha.acoustic_model = "{{acoustic_model}}";
  config.model.matcha.vocoder = "{{vocoder}}";
{%- if lexicon %}
  config.model.matcha.lexicon = "{{lexicon}}";
{%- endif %}
  config.model.matcha.tokens = "{{tokens}}";
{%- if data_dir %}
  config.model.matcha.data_dir = "{{data_dir}}";
{%- endif %}
  config.model.num_threads = 1;

  // If you want to see debug messages, please set it to 1
  config.model.debug = 0;

{%- if rule_fsts %}
  config.rule_fsts = "{{rule_fsts}}";
{%- endif %}

  std::string filename = "./test.wav";
  std::string text = "{{text}}";

  auto tts = OfflineTts::Create(config);
  int32_t sid = 0;
  float speed = 1.0; // larger -> faster in speech speed

#if 0
  // If you don't want to use a callback, then please enable this branch
  GeneratedAudio audio = tts.Generate(text, sid, speed);
#else
  GeneratedAudio audio = tts.Generate(text, sid, speed, ProgressCallback);
#endif

  WriteWave(filename, {audio.samples, audio.sample_rate});

  fprintf(stderr, "Input text is: %s\n", text.c_str());
  fprintf(stderr, "Speaker ID is: %d\n", sid);
  fprintf(stderr, "Saved to: %s\n", filename.c_str());

  return 0;
}
